<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Jurídico Completa</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/727/727399.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
    <style>
        :root {
            --cor-vinho: #5D1A2A;
            --cor-dourado: #D4AF37;
            --cor-dourado-hover: #c09b2d;
            --cor-bege-claro: #F3EAD3;
            --cor-bege-fundo: #EFEBE0;
            --cor-texto-escuro: #3d2c21;
            --main: var(--cor-vinho);
            --accent: var(--cor-dourado);
            --accent-light: var(--cor-bege-claro);
            --danger: #ef4444;
            --success: #10b981;
            --info: #0ea5e9;
            --warning: #f59e0b;
            --bg: var(--cor-bege-fundo);
            --white: #ffffff;
            --border: #ddd3bb;
            --dark-text: var(--cor-texto-escuro);
            --muted-text: #8c7a6b;
            --radius: 1rem;
            --shadow: 0 4px 18px rgba(0, 0, 0, .08);
            --transition: .2s ease-in-out;
            font-family: 'Inter', system-ui, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--dark-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        header {
            background: var(--main);
            color: var(--white);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            gap: 1.5rem;
        }

        header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--cor-bege-claro);
            flex-shrink: 0;
        }

        nav {
            flex-grow: 1;
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        nav button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(243, 234, 211, 0.3);
            color: var(--cor-bege-claro);
            padding: .6rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: .7rem;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        nav button:hover {
            background: var(--cor-dourado);
            border-color: var(--cor-dourado-hover);
            color: var(--cor-texto-escuro);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        nav button.active {
            background: var(--cor-dourado);
            border-color: var(--cor-dourado);
            color: var(--cor-texto-escuro);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        nav button:active {
            transform: scale(0.97);
            transition: transform .1s ease;
        }

        header>button.btn {
            margin-left: auto;
            flex-shrink: 0;
        }

        .btn {
            background: var(--accent);
            color: var(--cor-texto-escuro);
            border: none;
            padding: .75rem 1.5rem;
            font-size: .95rem;
            font-weight: 600;
            border-radius: .7rem;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--cor-dourado-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, .3);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, .4);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, .4);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .btn-info:hover {
            background: #0284c7;
            box-shadow: 0 4px 12px rgba(14, 165, 233, .4);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 2rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn .4s;
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-header h2 {
            font-size: 1.8rem;
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            flex-grow: 1;
            min-width: 200px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: .9rem 1rem;
            font-size: .98rem;
            border: 1.5px solid var(--border);
            border-radius: .65rem;
            background: var(--cor-bege-claro);
            transition: all var(--transition);
            font-family: 'Inter', sans-serif;
            color: var(--cor-texto-escuro);
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px #c09b2d55;
            outline: none;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: .5rem;
            font-size: .9rem;
        }

        #login-panel {
            max-width: 400px;
            margin: 10vh auto;
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        #login-panel h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--main);
        }

        #login-erro {
            color: var(--danger);
            margin-top: 1rem;
            font-size: .9rem;
            display: none;
        }

        #painel-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        #resumo-financeiro.painel-cards {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2rem;
        }

        #resumo-financeiro.painel-cards .card {
            flex: 0 1 260px;
            min-width: 220px;
        }

        .card {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: .5rem;
            transition: all var(--transition);
            border: 1px solid #ddd3bb;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .1);
            border-color: var(--accent);
        }

        .card .icon {
            font-size: 1.8rem;
            color: var(--main);
        }

        .card .value {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .card .label {
            color: var(--muted-text);
            font-weight: 500;
        }

        .chart-container {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2.5rem;
        }

        #painel-prazos ul {
            list-style: none;
            padding: 1rem 0;
        }

        #painel-prazos li {
            background: var(--accent-light);
            padding: .8rem 1.2rem;
            border-radius: .8rem;
            margin-bottom: .5rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .table-wrapper {
            overflow-x: auto;
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem 1.2rem;
            text-align: left;
            font-size: .95rem;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: transparent;
            color: var(--muted-text);
            font-weight: 600;
            text-transform: uppercase;
            font-size: .8rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--cor-bege-fundo);
        }

        td .actions {
            display: flex;
            gap: .5rem;
        }

        td .actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--muted-text);
            padding: .3rem;
            transition: color var(--transition);
        }

        td .actions button:hover {
            color: var(--accent);
        }

        .badge {
            display: inline-block;
            padding: .3rem .8rem;
            border-radius: 99px;
            font-size: .8rem;
            font-weight: 600;
            color: var(--cor-texto-escuro);
            text-align: center;
        }

        .badge.Ativo,
        .badge.Agendado {
            background: var(--accent);
        }

        .badge.Concluído,
        .badge.Concluída,
        .badge.Realizado,
        .badge.Pago {
            background: var(--success);
            color: var(--white);
        }

        .badge.Arquivado,
        .badge.Cancelado {
            background: var(--muted-text);
            color: var(--white);
        }

        .badge.Pendente,
        .badge.Vencido {
            background: var(--warning);
        }

        .badge.Alta {
            background: var(--danger);
            color: var(--white);
        }

        .badge.Média {
            background: var(--warning);
        }

        .badge.Baixa {
            background: var(--info);
            color: var(--white);
        }

        .badge.Receber {
            background: var(--success);
            color: var(--white);
        }

        .badge.Pagar {
            background: var(--danger);
            color: var(--white);
        }

        .modal-bg {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(61, 44, 33, .5);
            backdrop-filter: blur(4px);
            z-index: 999;
            animation: fadeIn .3s;
        }

        .modal-bg.active {
            display: flex;
        }

        .modal {
            background: var(--cor-bege-fundo);
            border-radius: var(--radius);
            padding: 2rem 2.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .1);
            animation: scaleIn .3s;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--muted-text);
            cursor: pointer;
            line-height: 1;
        }

        .modal-footer {
            margin-top: 2rem;
            text-align: right;
        }

        #notificacoes {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            width: 320px;
        }

        .notif {
            background: var(--cor-bege-claro);
            border-left: 5px solid var(--accent);
            padding: 1rem 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            border-radius: .8rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .1);
            margin-bottom: 1rem;
            animation: slideIn .4s forwards;
            transform: translateX(120%);
            color: var(--cor-texto-escuro);
        }

        .notif.success {
            border-left-color: var(--success);
        }

        .notif.danger {
            border-left-color: var(--danger);
        }

        .notif i {
            font-size: 1.4rem;
            opacity: .8;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideIn {
            to {
                transform: translateX(0);
            }
        }

        .cliente-card {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .cliente-card h3 {
            font-size: 1.4rem;
            color: var(--main);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--cor-dourado);
            padding-bottom: .5rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 4rem auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .calendar-container {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        /* Estilos para o FullCalendar */
        .fc .fc-button {
            background-color: var(--accent);
            border-color: var(--accent);
            color: var(--cor-texto-escuro);
            text-transform: capitalize;
            /* Garante que o texto dos botões seja capitalizado */
        }

        .fc .fc-button:hover {
            background-color: var(--cor-dourado-hover);
            border-color: var(--cor-dourado-hover);
        }

        .fc .fc-button-primary:not(:disabled).fc-button-active {
            background-color: var(--main);
            border-color: var(--main);
            color: var(--white);
            /* Cor do texto para o botão ativo */
        }

        .fc .fc-toolbar-title {
            color: var(--dark-text);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .fc .fc-col-header-cell-cushion {
            color: var(--main);
            font-weight: 600;
            padding: .5rem 0;
            /* Espaçamento para os dias da semana */
        }

        .fc .fc-daygrid-day-number {
            color: var(--dark-text);
            font-weight: 500;
            padding: .2rem .4rem;
        }

        .fc .fc-daygrid-day.fc-day-today {
            background-color: var(--accent-light);
            /* Cor de fundo para o dia atual */
            border-radius: .5rem;
        }

        .fc .fc-event {
            background-color: var(--main);
            border-color: var(--main);
            border-radius: .3rem;
            padding: .2rem .4rem;
            margin-bottom: 3px;
            /* Aumenta um pouco o espaçamento entre eventos empilhados */
            font-size: .85rem;
            color: var(--white);
            cursor: pointer;
        }

        .fc .fc-event-title {
            color: var(--white);
            font-size: .85rem;
        }

        .fc-event-time {
            font-weight: 600;
        }

        .fc-daygrid-event-dot {
            border-color: var(--white);
        }

        .fc .fc-event.status-agendado {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .fc .fc-event.status-realizado {
            background-color: var(--success);
            border-color: var(--success);
        }

        .fc .fc-event.status-cancelado {
            background-color: var(--danger);
            border-color: var(--danger);
        }

        .fc .fc-event.status-pendente {
            background-color: var(--warning);
            border-color: var(--warning);
        }

        .calendar-container {
            display: block;
        }

        /* Responsividade para o calendário */
        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
            }

            .fc .fc-toolbar-title {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }

            .fc .fc-button-group {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }

            .fc .fc-button {
                margin: .2rem;
                padding: .4rem .8rem;
            }

            .fc-daygrid-day-number {
                font-size: .8rem;
            }

            .fc .fc-event {
                font-size: .75rem;
                padding: .1rem .3rem;
            }

            .fc-list-event .fc-event-main-frame {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .fc-list-event .fc-event-details {
                margin-top: 0.5rem;
            }

            .calendar-container {
                display: none;
            }

            .card .value {
                font-size: 1.5rem;
                /* Reduzido para caber melhor */
            }
        }

        /* Otimização do layout do dashboard-grid */
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            /* Ajuste para telas menores */
        }

        @media(max-width: 800px) {

            .filter-bar,
            .section-header {
                flex-direction: column;
                padding: 1rem;
                align-items: stretch;
            }

            .container {
                padding: 1.5rem 1rem;
            }

            .modal {
                padding: 1.5rem;
            }

            .table-wrapper {
                box-shadow: none;
            }

            table {
                box-shadow: var(--shadow);
            }

            thead {
                display: none;
            }

            tr {
                display: block;
                margin-bottom: 1rem;
                border-radius: .8rem;
                overflow: hidden;
                box-shadow: var(--shadow);
                background: var(--cor-bege-claro);
            }

            td {
                display: block;
                text-align: right;
                position: relative;
                padding-left: 50%;
                border: none;
                border-bottom: 1px solid var(--border);
            }

            td:before {
                content: attr(data-label);
                position: absolute;
                left: 1rem;
                width: calc(50% - 2rem);
                text-align: left;
                font-weight: 600;
                color: var(--main);
            }

            td:last-child {
                border-bottom: none;
            }
        }

        .hamburger-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background: var(--main);
            padding-top: 60px;
            transition: left 0.3s ease;
            z-index: 1000;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar-nav button {
            background: none;
            border: none;
            color: var(--cor-bege-claro);
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-align: left;
        }

        .sidebar-nav button:hover {
            background: var(--cor-dourado);
            color: var(--cor-texto-escuro);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .report-card {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            cursor: pointer;
            transition: all var(--transition);
            border: 1px solid var(--border);
            text-align: center;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .1);
            border-color: var(--accent);
            color: var(--main);
        }

        .report-card i {
            font-size: 2.5rem;
            color: var(--main);
        }

        .report-card span {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .pagination-container button {
            background: var(--cor-bege-claro);
            border: 1px solid var(--border);
            color: var(--dark-text);
            padding: .5rem 1rem;
            border-radius: .5rem;
            cursor: pointer;
            transition: all var(--transition);
        }

        .pagination-container button:hover {
            background: var(--accent);
            color: var(--cor-texto-escuro);
        }

        .pagination-container button.active {
            background: var(--main);
            color: var(--white);
            border-color: var(--main);
        }

        /* Estilos para o Spinner e Overlay */
        .spinner-overlay {
            display: none;
            /* Começa escondido */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-family: sans-serif;
        }

        .spinner-overlay.show {
            display: flex;
            /* Mostra o spinner */
        }

        .spinner-overlay .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--cor-dourado);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
            margin-bottom: 15px;
        }

        @media(max-width: 1024px) {
            header nav {
                display: none;
            }

            header {
                display: grid;
                grid-template-columns: auto 1fr auto;
                align-items: center;
                padding: 1rem;
                gap: 1rem;
            }

            .hamburger-menu-btn {
                display: block;
                grid-column: 1;
                justify-self: start;
            }

            header h1 {
                grid-column: 2;
                justify-self: center;
                font-size: 1.2rem;
                margin: 0;
            }

            #btnLogout {
                display: inline-flex;
                grid-column: 3;
                justify-self: end;
                background: none;
                color: white;
                padding: 0.5rem;
                font-size: 1.2rem;
                box-shadow: none;
            }

            #btnLogout span {
                display: none;
                /* Esconde o texto "Sair" */
            }

            #btnLogout .fa-sign-out-alt {
                margin: 0;
            }
        }
    </style>
</head>

<body>

    <div id="spinner-overlay" class="spinner-overlay">
        <div class="spinner"></div>
        <p>Aguarde...</p>
    </div>

    <div id="login-panel">
        <h2><i class="fa-solid fa-scale-balanced"></i> Login do Advogado</h2>
        <div class="form-group">
            <label for="login-email">Email</label>
            <input id="login-email" type="email" placeholder="seu@email.com" required>
        </div>
        <div class="form-group">
            <label for="login-senha">Senha</label>
            <input id="login-senha" type="password" placeholder="Senha" required>
        </div>
        <button id="btnLogin" class="btn" style="width: 100%;">Entrar</button>
        <div id="login-erro"></div>
    </div>

    <div id="app" style="display:none">
        <header>
            <button id="hamburger-menu" class="hamburger-menu-btn">
                <i class="fa fa-bars"></i>
            </button>
            <h1><i class="fa-solid fa-scale-balanced" style="color: var(--success);"></i> Painel Jurídico</h1>
            <nav>
                <button id="nav0" class="active" onclick="abrirTab(0)"><i class="fa fa-chart-pie"></i> Painel</button>
                <button id="nav1" onclick="abrirTab(1)"><i class="fa fa-briefcase"></i> Casos</button>
                <button id="nav2" onclick="abrirTab(2)"><i class="fa fa-users"></i> Clientes</button>
                <button id="nav3" onclick="abrirTab(3)"><i class="fa fa-folder-open"></i> Documentos</button>
                <button id="nav4" onclick="abrirTab(4)"><i class="fa fa-calendar-alt"></i> Agenda</button>
                <button id="nav5" onclick="abrirTab(5)"><i class="fa fa-tasks"></i> Tarefas</button>
                <button id="nav6" onclick="abrirTab(6)"><i class="fa fa-hand-holding-dollar"></i> Financeiro</button>
                <button id="nav7" onclick="abrirTab(7)"><i class="fa fa-users"></i> Casos por Clientes</button>
                <button id="nav8" onclick="abrirTab(8)"><i class="fa fa-file-excel"></i> Relatórios</button>
            </nav>
            <button id="btnLogout" class="btn" style="background: #fff1f3; color:#d43c5e;"><span>Sair</span> <i
                    class="fa fa-sign-out-alt"></i></button>
        </header>

        <aside id="sidebar" class="sidebar">
            <nav class="sidebar-nav">
                <button id="nav0-sidebar" class="active" onclick="abrirTab(0); closeSidebar();"><i
                        class="fa fa-chart-pie"></i> Painel</button>
                <button id="nav1-sidebar" onclick="abrirTab(1); closeSidebar();"><i class="fa fa-briefcase"></i>
                    Casos</button>
                <button id="nav2-sidebar" onclick="abrirTab(2); closeSidebar();"><i class="fa fa-users"></i>
                    Clientes</button>
                <button id="nav3-sidebar" onclick="abrirTab(3); closeSidebar();"><i class="fa fa-folder-open"></i>
                    Documentos</button>
                <button id="nav4-sidebar" onclick="abrirTab(4); closeSidebar();"><i class="fa fa-calendar-alt"></i>
                    Agenda</button>
                <button id="nav5-sidebar" onclick="abrirTab(5); closeSidebar();"><i class="fa fa-tasks"></i>
                    Tarefas</button>
                <button id="nav6-sidebar" onclick="abrirTab(6); closeSidebar();"><i
                        class="fa fa-hand-holding-dollar"></i> Financeiro</button>
                <button id="nav7-sidebar" onclick="abrirTab(7); closeSidebar();"><i class="fa fa-users"></i> Casos por
                    Clientes</button>
                <button id="nav8-sidebar" onclick="abrirTab(8); closeSidebar();"><i class="fa fa-file-excel"></i>
                    Relatórios</button>
            </nav>
        </aside>

        <div id="overlay" class="overlay"></div>

        <main class="container">
            <div id="notificacoes"></div>

            <!-- TAB: PAINEL GERAL -->
            <div class="tab-content active" id="tab0">
                <div class="section-header">
                    <h2>Visão Geral</h2>
                </div>
                <div class="dashboard-grid">
                    <div class="card"><i class="icon fa fa-users"></i>
                        <div class="value" id="total-clientes">0</div>
                        <div class="label">Total de Clientes</div>
                    </div>
                    <div class="card"><i class="icon fa fa-briefcase"></i>
                        <div class="value" id="casos-ativos">0</div>
                        <div class="label">Casos Ativos</div>
                    </div>
                    <div class="card"><i class="icon fa fa-calendar-check"></i>
                        <div class="value" id="eventos-agendados">0</div>
                        <div class="label">Eventos Agendados</div>
                    </div>
                    <div class="card"><i class="icon fa fa-hand-holding-dollar"></i>
                        <div class="value" id="total-a-receber">R$ 0,00</div>
                        <div class="label">Total a Receber</div>
                    </div>
                </div>
                <div class="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- TAB: CASOS -->
            <div class="tab-content" id="tab1">
                <div class="section-header">
                    <h2>Casos & Processos</h2>
                </div>
                <div class="filter-bar">
                    <input id="buscar-caso" type="text" placeholder="Buscar por nº do processo, cliente, partes…"
                        onkeyup="renderCasos()">
                    <select id="filtro-caso-status" onchange="renderCasos()">
                        <option value="">Todos os Status</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Concluído">Concluído</option>
                        <option value="Arquivado">Arquivado</option>
                    </select>
                    <button class="btn btn-success" onclick="abrirModalCaso()"><i class="fa fa-plus"></i> Novo
                        Caso</button>
                </div>
                <div class="table-wrapper" id="tabela-casos"></div>
                <div id="paginacao-casos" class="pagination-container"></div>
            </div>

            <!-- TAB: CLIENTES -->
            <div class="tab-content" id="tab2">
                <div class="section-header">
                    <h2>Clientes</h2>
                </div>
                <div class="filter-bar">
                    <input id="buscar-cliente" type="text" placeholder="Buscar por nome, e-mail, telefone…"
                        onkeyup="renderClientes()">
                    <button class="btn btn-success" onclick="abrirModalCliente()"><i class="fa fa-plus"></i> Novo
                        Cliente</button>
                </div>
                <div class="table-wrapper" id="tabela-clientes"></div>
                <div id="paginacao-clientes" class="pagination-container"></div>
            </div>

            <!-- TAB: DOCUMENTOS -->
            <div class="tab-content" id="tab3">
                <div class="section-header">
                    <h2>Gestão de Documentos</h2>
                </div>
                <div class="filter-bar">
                    <input id="doc-filtro-cliente-busca" type="text" placeholder="Buscar por nome do cliente..." onkeyup="renderDocumentos(1)">
                    <button class="btn" onclick="abrirModalAtalho()"><i class="fa fa-link"></i> Criar Atalho</button>
                    <button class="btn" onclick="abrirModalGerenciarAtalhos()"><i class="fa fa-edit"></i> Editar/Deletar Atalhos</button>
                    <button class="btn btn-success" onclick="abrirModalDocumento()"><i class="fa fa-upload"></i> Anexar
                        Documento</button>
                </div>
                <div id="atalhos-container" class="atalhos-bar" style="margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                <div class="table-wrapper" id="tabela-documentos"></div>
                <div id="paginacao-documentos" class="pagination-container"></div>
            </div>

            <!-- TAB: AGENDA -->
            <div class="tab-content" id="tab4">
                <div class="section-header">
                    <h2>Agenda & Prazos</h2>
                    <button class="btn btn-success" onclick="abrirModalEvento()"><i class="fa fa-calendar-plus"></i>
                        Novo Evento</button>
                </div>
                <div class="filter-bar">
                    <input id="agenda-filtro-data" type="date" onchange="renderAgenda()">
                    <select id="agenda-filtro-tipo" onchange="renderAgenda()">
                        <option value="">Todos os Tipos</option>
                        <option>Audiência</option>
                        <option>Reunião</option>
                        <option>Prazo Processual</option>
                        <option>Outro</option>
                    </select>
                </div>
                <div class="table-wrapper" id="tabela-agenda"></div>
                <div id="paginacao-agenda" class="pagination-container"></div>
            </div>

            <!-- TAB: TAREFAS -->
            <div class="tab-content" id="tab5">
                <div class="section-header">
                    <h2>Controle de Tarefas</h2>
                    <button class="btn btn-success" onclick="abrirModalTarefa()"><i class="fa fa-plus"></i> Nova
                        Tarefa</button>
                </div>
                <div class="filter-bar">
                    <select id="filtro-tarefa-status" onchange="renderTarefas()">
                        <option value="Pendente">Pendentes</option>
                        <option value="">Todas</option>
                        <option value="Concluída">Concluídas</option>
                    </select>
                    <select id="filtro-tarefa-prioridade" onchange="renderTarefas()">
                        <option value="">Todas as Prioridades</option>
                        <option>Alta</option>
                        <option>Média</option>
                        <option>Baixa</option>
                    </select>
                </div>
                <div class="table-wrapper" id="tabela-tarefas"></div>
                <div id="paginacao-tarefas" class="pagination-container"></div>
            </div>

            <!-- TAB: FINANCEIRO -->
            <div class="tab-content" id="tab6">
                <div class="section-header">
                    <h2>Financeiro</h2>
                </div>
                <div id="resumo-financeiro" class="painel-cards"></div>
                <div class="section-header" style="margin-top: 2.5rem; margin-bottom: 1rem;">
                    <h3 style="font-size: 1.5rem;">Histórico de Lançamentos</h3>
                    <div class="filter-bar" style="margin-bottom: 0;">
                        <button class="btn btn-success" onclick="abrirModalFin('Receber')"><i class="fa fa-plus"></i>
                            Nova Receita</button>
                        <button class="btn btn-danger" onclick="abrirModalFin('Pagar')"><i class="fa fa-minus"></i> Nova
                            Despesa</button>
                    </div>
                </div>
                <div class="table-wrapper" id="tabela-financeiro"></div>
            </div>

            <!-- TAB: CASOS POR CLIENTE -->
            <div class="tab-content" id="tab7">
                <div class="section-header">
                    <h2>Casos por Cliente</h2>
                </div>
                <div class="filter-bar">
                    <input id="buscar-casos-por-cliente" type="text" placeholder="Buscar por nome do cliente…"
                        onkeyup="renderCasosPorCliente()">
                </div>
                <div id="casos-por-cliente-container"></div>
                <div id="paginacao-casos-por-cliente" class="pagination-container"></div>
            </div>

            <!-- TAB: RELATÓRIOS -->
            <div class="tab-content" id="tab8">
                <div class="section-header">
                    <h2>Relatórios</h2>
                </div>
                <p style="margin-bottom: 2rem; color: var(--muted-text);">Selecione um relatório para gerar e baixar
                    como
                    uma planilha CSV.</p>
                <div class="reports-grid">
                    <div class="report-card"
                        onclick="gerarRelatorio('clientes', 'Relatorio_Clientes.csv', {'id':'ID', 'nome':'Nome', 'email':'Email', 'fone':'Telefone', 'notas':'Notas'})">
                        <i class="fa fa-users"></i>
                        <span>Relatório de Clientes</span>
                    </div>
                    <div class="report-card"
                        onclick="gerarRelatorio('casos', 'Relatorio_Casos.csv', {'id':'ID', 'numero':'Nº Processo', 'partes':'Partes', 'status':'Status', 'cliente_nome':'Cliente'})">
                        <i class="fa fa-briefcase"></i>
                        <span>Relatório de Casos</span>
                    </div>
                    <div class="report-card"
                        onclick="gerarRelatorio('docs', 'Relatorio_Documentos.csv', {'id':'ID', 'titulo':'Título', 'nome_arquivo':'Nome Arquivo', 'data':'Data', 'cliente_nome':'Cliente', 'caso_numero':'Nº Processo'})">
                        <i class="fa fa-folder-open"></i>
                        <span>Relatório de Documentos</span>
                    </div>
                    <div class="report-card"
                        onclick="gerarRelatorio('agenda', 'Relatorio_Agenda.csv', {'id':'ID', 'titulo':'Título', 'tipo_evento':'Tipo', 'datahora':'Data/Hora', 'status':'Status', 'local':'Local'})">
                        <i class="fa fa-calendar-alt"></i>
                        <span>Relatório da Agenda</span>
                    </div>
                    <div class="report-card"
                        onclick="gerarRelatorio('tarefas', 'Relatorio_Tarefas.csv', {'id':'ID', 'descricao':'Descrição', 'status':'Status', 'prioridade':'Prioridade', 'prazo_data':'Prazo'})">
                        <i class="fa fa-tasks"></i>
                        <span>Relatório de Tarefas</span>
                    </div>
                    <div class="report-card"
                        onclick="gerarRelatorio('fin', 'Relatorio_Financeiro.csv', {'id':'ID', 'descricao':'Descrição', 'tipo':'Tipo', 'categoria':'Categoria', 'valor':'Valor', 'data':'Data', 'status_pg':'Status Pagamento'})">
                        <i class="fa fa-hand-holding-dollar"></i>
                        <span>Relatório Financeiro</span>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- ========= MODAIS ========= -->
    <div class="modal-bg" id="modal-caso">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-caso-titulo">Novo Caso</h3><button class="close-modal"
                    onclick="fecharModal('modal-caso')">&times;</button>
            </div>
            <form onsubmit="salvarCaso(event);">
                <input type="hidden" id="caso-id">
                <div class="form-group"><label for="caso-cliente">Cliente *</label><select id="caso-cliente"
                        required></select></div>
                <div class="form-group"><label for="caso-numero">Nº do Processo *</label><input id="caso-numero"
                        type="text" maxlength="60" required></div>
                <div class="form-group"><label for="caso-partes">Partes Envolvidas</label><textarea id="caso-partes"
                        placeholder="Autor, réu, terceiro..." rows="3"></textarea></div>
                <div class="form-group"><label for="caso-responsavel">Advogado Responsável</label><input
                        id="caso-responsavel" type="text"></div>
                <div class="form-group"><label for="caso-data">Data de Abertura</label><input id="caso-data"
                        type="date"></div>
                <div class="form-group"><label for="caso-status">Status</label><select id="caso-status">
                        <option>Ativo</option>
                        <option>Concluído</option>
                        <option>Arquivado</option>
                    </select></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-cliente">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="modal-cliente-titulo">Novo Cliente</h3><button class="close-modal"
                    onclick="fecharModal('modal-cliente')">&times;</button>
            </div>
            <form onsubmit="salvarCliente(event);">
                <input type="hidden" id="cliente-id">
                <div class="form-group"><label for="cliente-nome">Nome Completo *</label><input id="cliente-nome"
                        type="text" required></div>
                <div class="form-group"><label for="cliente-email">E-mail</label><input id="cliente-email" type="email">
                </div>
                <div class="form-group"><label for="cliente-fone">Telefone</label><input id="cliente-fone" type="tel">
                </div>
                <div class="form-group"><label for="cliente-notas">Anotações / Preferências</label><textarea
                        id="cliente-notas" rows="4"></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-documento">
        <div class="modal">
            <div class="modal-header">
                <h3>Anexar Documento</h3><button class="close-modal"
                    onclick="fecharModal('modal-documento')">&times;</button>
            </div>
            <form onsubmit="salvarDocumento(event);">
                <p style="font-size: .85rem; color: var(--muted-text); margin-bottom: 1rem;">Anexe arquivos a um cliente
                    ou caso. Os arquivos são salvos na nuvem de forma segura.</p>
                <input type="hidden" id="doc-id">
                <div class="form-group"><label for="doc-cliente">Cliente *</label><select id="doc-cliente"
                        required></select></div>
                <div class="form-group"><label for="doc-caso">Vincular ao Caso (opcional)</label><select
                        id="doc-caso"></select></div>
                <div class="form-group"><label for="doc-titulo">Título / Descrição *</label><input id="doc-titulo"
                        type="text" required></div>
                <div class="form-group"><label for="doc-link">Link do Documento (Google Drive) *</label><input id="doc-link" type="url"
                        placeholder="Cole o link compartilhável do Google Drive aqui" required></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-evento">
        <div class="modal">
            <div class="modal-header">
                <h3 id="evento-modal-titulo">Novo Evento / Prazo</h3><button class="close-modal"
                    onclick="fecharModal('modal-evento')">&times;</button>
            </div>
            <form onsubmit="salvarEvento(event);">
                <input type="hidden" id="evento-id">
                <div class="form-group"><label for="evento-titulo">Título *</label><input id="evento-titulo" type="text"
                        required></div>
                <div class="form-group"><label for="evento-tipo">Tipo de Evento *</label><select id="evento-tipo"
                        required>
                        <option>Audiência</option>
                        <option>Reunião</option>
                        <option>Prazo Processual</option>
                        <option>Outro</option>
                    </select></div>
                <div class="form-group"><label for="evento-datahora">Data e Hora *</label><input id="evento-datahora"
                        type="datetime-local" required></div>
                <div class="form-group"><label for="evento-local">Local / Link</label><input id="evento-local"
                        type="text" placeholder="Ex: Fórum Central, link da chamada..."></div>
                <div class="form-group"><label for="evento-cliente">Vincular ao Cliente</label><select
                        id="evento-cliente"
                        onchange="populateSelect('evento-caso', 'casos', 'id', 'numero', this.value, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="evento-caso">Vincular ao Caso</label><select
                        id="evento-caso"></select></div>
                <div class="form-group"><label for="evento-status">Status</label><select id="evento-status">
                        <option>Agendado</option>
                        <option>Realizado</option>
                        <option>Cancelado</option>
                    </select></div>
                <div class="form-group"><label for="evento-descricao">Descrição</label><textarea id="evento-descricao"
                        rows="3"></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-tarefa">
        <div class="modal">
            <div class="modal-header">
                <h3 id="tarefa-modal-titulo">Nova Tarefa</h3><button class="close-modal"
                    onclick="fecharModal('modal-tarefa')">&times;</button>
            </div>
            <form onsubmit="salvarTarefa(event);">
                <input type="hidden" id="tarefa-id">
                <div class="form-group"><label for="tarefa-descricao">Descrição *</label><textarea id="tarefa-descricao"
                        rows="3" required></textarea></div>
                <div class="form-group"><label for="tarefa-prioridade">Prioridade</label><select id="tarefa-prioridade">
                        <option>Baixa</option>
                        <option>Média</option>
                        <option>Alta</option>
                    </select></div>
                <div class="form-group"><label for="tarefa-prazo">Data do Prazo</label><input id="tarefa-prazo"
                        type="date"></div>
                <div class="form-group"><label for="tarefa-cliente">Vincular ao Cliente</label><select
                        id="tarefa-cliente"
                        onchange="populateSelect('tarefa-caso', 'casos', 'id', 'numero', this.value, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="tarefa-caso">Vincular ao Caso</label><select
                        id="tarefa-caso"></select></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-fin">
        <div class="modal">
            <div class="modal-header">
                <h3 id="fin-titulo">Novo Lançamento</h3><button class="close-modal"
                    onclick="fecharModal('modal-fin')">&times;</button>
            </div>
            <form onsubmit="salvarFin(event);">
                <input type="hidden" id="fin-id"><input type="hidden" id="fin-tipo">
                <div class="form-group"><label for="fin-descricao">Descrição *</label><input id="fin-descricao"
                        type="text" required></div>
                <div class="form-group"><label for="fin-categoria">Categoria *</label><select id="fin-categoria"
                        required>
                        <option>Honorários</option>
                        <option>Custas Processuais</option>
                        <option>Acordo</option>
                        <option>Serviços de Terceiros</option>
                        <option>Despesas Gerais</option>
                        <option>Outra</option>
                    </select></div>
                <div class="form-group"><label for="fin-valor">Valor (R$) *</label><input id="fin-valor" type="number"
                        step="0.01" placeholder="Ex: 1500.50" required></div>
                <div class="form-group"><label for="fin-data">Data *</label><input id="fin-data" type="date" required>
                </div>
                <div class="form-group"><label for="fin-status">Status Pagamento</label><select id="fin-status">
                        <option>Pendente</option>
                        <option>Pago</option>
                        <option>Vencido</option>
                    </select></div>
                <div class="form-group"><label for="fin-cliente">Vincular ao Cliente</label><select id="fin-cliente"
                        onchange="populateSelect('fin-caso', 'casos', 'id', 'numero', this.value, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="fin-caso">Vincular ao Caso</label><select id="fin-caso"></select>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
</div>
<div class="modal-bg" id="modal-atalho">
    <div class="modal">
        <div class="modal-header">
            <h3>Criar Atalho</h3>
            <button class="close-modal" onclick="fecharModal('modal-atalho')">&times;</button>
        </div>
        <form onsubmit="salvarAtalho(event)">
            <div class="form-group">
                <label for="atalho-nome">Nome do Atalho</label>
                <input id="atalho-nome" type="text" required>
            </div>
            <div class="form-group">
                <label for="atalho-link">Link do Atalho</label>
                <input id="atalho-link" type="url" required>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Salvar</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-bg" id="modal-gerenciar-atalhos">
    <div class="modal">
        <div class="modal-header">
            <h3>Gerenciar Atalhos</h3>
            <button class="close-modal" onclick="fecharModal('modal-gerenciar-atalhos')">&times;</button>
        </div>
        <div id="atalhos-edicao-container"></div>
    </div>
</div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script>
        // =================================================================================
        // PAINEL JURÍDICO - SCRIPT COMPLETO (Versão Firebase)
        // =================================================================================

        // Cole aqui as configurações do seu projeto Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBlQ82VwKC5DWScw0DmMOfoG8B5OHc9v1w",
            authDomain: "banco-de-dados-adv.firebaseapp.com",
            projectId: "banco-de-dados-adv",
            storageBucket: "banco-de-dados-adv.firebasestorage.app",
            messagingSenderId: "948017779164",
            appId: "1:948017779164:web:fd97b016849af7eb337f19"
        };
        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        // -- INSTÂNCIAS DOS GRÁFICOS --
        let overviewChart, reportsChart;

        /* ------------- HELPERS GLOBAIS ------------- */
        const SPINNER_HTML = '<div class="spinner"></div>';
        const fmtDate = (d) => d ? new Date(d).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';
        const fmtDateTime = (d) => d ? new Date(d).toLocaleString('pt-BR', { timeZone: 'UTC' }) : '';
        const fmtCurrency = (v) => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // Funções para controlar o spinner
        const spinnerOverlay = document.getElementById('spinner-overlay');

        function showSpinner(message = 'Aguarde...') {
            const overlay = document.getElementById('spinner-overlay');
            overlay.querySelector('p').textContent = message;
            overlay.style.display = 'flex';
        }

        function hideSpinner() {
            const overlay = document.getElementById('spinner-overlay');
            overlay.style.display = 'none';
        }

        function showNotif(type, msg) {
            const icons = { success: 'fa-check-circle', danger: 'fa-times-circle', info: 'fa-info-circle' };
            const div = document.createElement('div');
            div.className = `notif ${type}`;
            div.innerHTML = `<i class="fa ${icons[type]}"></i><span>${msg}</span>`;
            $('#notificacoes').appendChild(div);
            setTimeout(() => {
                div.style.animation = 'slideOut .4s forwards';
                setTimeout(() => div.remove(), 4000);
            }, 4000);
        }

        function fecharModal(modalId) { $(`#${modalId}`).classList.remove('active'); }

        async function populateSelect(selectId, collectionName, valueCol, textCol, filterValue = null, placeholder = 'Selecione', selectedValue = null) {
            const select = $(`#${selectId}`);
            select.innerHTML = `<option value="">${placeholder}</option>`;
            let query = db.collection(collectionName);
            if (filterValue) {
                query = query.where('cliente_id', '==', filterValue);
            }
            const snapshot = await query.get();

            if (!snapshot.empty) {
                const options = [];
                snapshot.forEach(doc => {
                    options.push({ id: doc.id, data: doc.data() });
                });

                // Ordena os resultados pelo campo de texto (ex: 'numero' do caso)
                options.sort((a, b) => {
                    const valA = a.data[textCol] || '';
                    const valB = b.data[textCol] || '';
                    return valA.localeCompare(valB, undefined, { numeric: true, sensitivity: 'base' });
                });

                options.forEach(opt => {
                    select.innerHTML += `<option value="${opt.id}">${opt.data[textCol]}</option>`;
                });
            }
            if (selectedValue) select.value = selectedValue;
        }

        /* ------------- FUNÇÕES DE RENDERIZAÇÃO (COM SPINNERS) ------------- */

        let calendar;

        async function loadDashboard() {
            // Load summary cards data
            $('#total-clientes').innerHTML = SPINNER_HTML;
            $('#casos-ativos').innerHTML = SPINNER_HTML;
            $('#eventos-agendados').innerHTML = SPINNER_HTML;
            $('#total-a-receber').innerHTML = SPINNER_HTML;

            const clientesSnapshot = await db.collection('clientes').get();
            $('#total-clientes').innerText = clientesSnapshot.size || 0;

            const casosAtivosSnapshot = await db.collection('casos').where('status', '==', 'Ativo').get();
            $('#casos-ativos').innerText = casosAtivosSnapshot.size || 0;

            const eventosAgendadosSnapshot = await db.collection('agenda').where('status', '==', 'Agendado').get();
            $('#eventos-agendados').innerText = eventosAgendadosSnapshot.size || 0;

            const financasSnapshot = await db.collection('fin').where('tipo', '==', 'Receber').where('status_pg', '==', 'Pendente').get();
            let a_receber = 0;
            financasSnapshot.forEach(doc => {
                a_receber += Number(doc.data().valor);
            });
            $('#total-a-receber').innerText = fmtCurrency(a_receber);

            // --- Optimized FullCalendar Initialization ---
            if (calendar) {
                calendar.refetchEvents();
            } else {
                const calendarEl = $('#calendar');
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
                    locale: 'pt-br',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listWeek'
                    },
                    eventOrder: 'start,title',
                    events: async (fetchInfo, successCallback, failureCallback) => {
                        try {
                            const startDate = fetchInfo.startStr.split('T')[0];
                            const endDate = fetchInfo.endStr.split('T')[0];

                            const agendaQuery = db.collection('agenda').where('datahora', '>=', startDate).where('datahora', '<', endDate);
                            const tarefasQuery = db.collection('tarefas').where('prazo_data', '>=', startDate).where('prazo_data', '<', endDate);

                            const [agendaSnapshot, tarefasSnapshot] = await Promise.all([agendaQuery.get(), tarefasQuery.get()]);

                            const events = [];
                            agendaSnapshot.forEach(doc => {
                                const event = doc.data();
                                events.push({
                                    id: doc.id,
                                    title: event.titulo,
                                    start: event.datahora,
                                    allDay: event.tipo_evento === 'Prazo Processual',
                                    extendedProps: { type: 'agenda', data: event },
                                    backgroundColor: event.status === 'Realizado' ? 'var(--success)' : (event.status === 'Cancelado' ? 'var(--danger)' : 'var(--main)'),
                                    borderColor: event.status === 'Realizado' ? 'var(--success)' : (event.status === 'Cancelado' ? 'var(--danger)' : 'var(--main)'),
                                });
                            });

                            tarefasSnapshot.forEach(doc => {
                                const tarefa = doc.data();
                                if (tarefa.prazo_data) {
                                    events.push({
                                        id: doc.id,
                                        title: `Tarefa: ${tarefa.descricao}`,
                                        start: tarefa.prazo_data,
                                        allDay: true,
                                        extendedProps: { type: 'tarefa', data: tarefa },
                                        backgroundColor: tarefa.status === 'Concluída' ? 'var(--success)' : 'var(--accent)',
                                        borderColor: tarefa.status === 'Concluída' ? 'var(--success)' : 'var(--accent)',
                                    });
                                }
                            });
                            successCallback(events);
                        } catch (err) {
                            console.error("Error fetching calendar events:", err);
                            showNotif('danger', 'Erro ao carregar eventos do calendário. Pode ser necessário criar um índice no Firestore. Verifique o console para mais detalhes.');
                            failureCallback(err);
                        }
                    },
                    dateClick: function(info) {
                        abrirModalEvento(null, info.dateStr);
                    },
                    eventClick: function (info) {
                        info.jsEvent.preventDefault();
                        if (info.event.extendedProps.type === 'agenda') {
                            abrirModalEvento(info.event.id);
                        } else if (info.event.extendedProps.type === 'tarefa') {
                            abrirModalTarefa(info.event.id);
                        }
                    },
                    eventContent: function(arg) {
                        const props = arg.event.extendedProps;
                        let icon = 'fa-star';
                        if (props.type === 'tarefa') {
                            icon = 'fa-tasks';
                        } else if (props.data && props.data.tipo_evento) {
                            switch(props.data.tipo_evento) {
                                case 'Audiência': icon = 'fa-gavel'; break;
                                case 'Reunião': icon = 'fa-handshake'; break;
                                case 'Prazo Processual': icon = 'fa-file-signature'; break;
                            }
                        }
                        return { html: `<div class="fc-event-main-frame"><i class="fa ${icon}" style="margin-right: 6px;"></i>${arg.event.title}</div>` };
                    },
                    loading: function(isLoading) {
                        if (isLoading) {
                            showSpinner('Carregando calendário...');
                        } else {
                            hideSpinner();
                        }
                    },
                    windowResize: function (view) {
                        if (window.innerWidth < 768) {
                            calendar.changeView('listWeek');
                        } else {
                            calendar.changeView('dayGridMonth');
                        }
                    }
                });
                calendar.render();
            }
        }

        async function renderCasos(page = 1) {
            $('#tabela-casos').innerHTML = SPINNER_HTML;
            const busca = $('#buscar-caso').value.toLowerCase();
            const status = $('#filtro-caso-status').value;
            let query = db.collection('casos');
            if (status) query = query.where('status', '==', status);

            // Fetch all clients to create a map
            const clientesSnapshot = await db.collection('clientes').get();
            const clientesMap = new Map();
            clientesSnapshot.forEach(doc => {
                clientesMap.set(doc.id, doc.data().nome);
            });

            const snapshot = await query.orderBy('numero').get();

            const table = $('#tabela-casos');
            const paginacaoContainer = $('#paginacao-casos');
            paginacaoContainer.innerHTML = '';

            if (snapshot.empty) {
                table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum caso encontrado.</p>`;
                return;
            }

            let rows = snapshot.docs.map(doc => {
                const r = { id: doc.id, ...doc.data() };
                r.clienteNome = clientesMap.get(r.cliente_id) || 'N/A';
                return r;
            }).filter(r => {
                return !busca ||
                    r.numero.toLowerCase().includes(busca) ||
                    (r.partes && r.partes.toLowerCase().includes(busca)) ||
                    r.clienteNome.toLowerCase().includes(busca);
            });

            const totalRows = rows.length;
            const rowsPerPage = 20;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedRows = rows.slice(start, end);

            table.innerHTML = `<table><thead><tr><th>Nº Processo</th><th>Cliente</th><th>Partes</th><th>Advogado Responsável</th><th>Data de Abertura</th><th>Status</th><th>Ações</th></tr></thead><tbody>
            ${paginatedRows.map(r => `<tr>
                <td data-label="Nº Processo">${r.numero}</td>
                <td data-label="Cliente">${r.clienteNome}</td>
                <td data-label="Partes">${r.partes || ''}</td>
                <td data-label="Advogado Responsável">${r.responsavel || ''}</td>
                <td data-label="Data de Abertura">${fmtDate(r.data)}</td>
                <td data-label="Status"><span class="badge ${r.status}">${r.status}</span></td>
                <td data-label="Ações"><div class="actions">
                    <button onclick="abrirModalCaso('${r.id}')" title="Editar"><i class="fa fa-edit"></i></button>
                    <button onclick="delRow('casos', '${r.id}', () => renderCasos(${page}))" title="Excluir"><i class="fa fa-trash"></i></button>
                </div></td>
            </tr>`).join('')}</tbody></table>`;

            if (totalPages > 1) {
                let paginationHTML = '';
                if (page > 1) {
                    paginationHTML += `<button onclick="renderCasos(${page - 1})">&laquo; Anterior</button>`;
                }
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button onclick="renderCasos(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
                }
                if (page < totalPages) {
                    paginationHTML += `<button onclick="renderCasos(${page + 1})">Próximo &raquo;</button>`;
                }
                paginacaoContainer.innerHTML = paginationHTML;
            }
        }

        async function renderClientes(page = 1) {
            $('#tabela-clientes').innerHTML = SPINNER_HTML;
            const busca = $('#buscar-cliente').value.toLowerCase();
            const query = db.collection('clientes');

            const snapshot = await query.orderBy('nome').get();
            const table = $('#tabela-clientes');
            const paginacaoContainer = $('#paginacao-clientes');
            paginacaoContainer.innerHTML = '';

            if (snapshot.empty) {
                table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum cliente encontrado.</p>`;
                return;
            }

            let rows = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(r => !busca ||
                    r.nome.toLowerCase().includes(busca) ||
                    (r.email && r.email.toLowerCase().includes(busca)) ||
                    (r.fone && r.fone.toLowerCase().includes(busca)));

            const totalRows = rows.length;
            const rowsPerPage = 20;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedRows = rows.slice(start, end);

            table.innerHTML = `<table><thead><tr><th>Nome</th><th>E-mail</th><th>Telefone</th><th>Anotações / Preferências</th><th>Ações</th></tr></thead><tbody>
            ${paginatedRows.map(r => `<tr>
                <td data-label="Nome">${r.nome}</td>
                <td data-label="E-mail">${r.email || ''}</td>
                <td data-label="Telefone">${r.fone || ''}</td>
                <td data-label="Anotações / Preferências">${r.notas || ''}</td>
                <td data-label="Ações"><div class="actions">
                    <button onclick="abrirModalCliente('${r.id}')" title="Editar"><i class="fa fa-edit"></i></button>
                    <button onclick="delRow('clientes', '${r.id}', () => renderClientes(${page}))" title="Excluir"><i class="fa fa-trash"></i></button>
                </div></td>
            </tr>`).join('')}</tbody></table>`;

            if (totalPages > 1) {
                let paginationHTML = '';
                if (page > 1) {
                    paginationHTML += `<button onclick="renderClientes(${page - 1})">&laquo; Anterior</button>`;
                }
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button onclick="renderClientes(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
                }
                if (page < totalPages) {
                    paginationHTML += `<button onclick="renderClientes(${page + 1})">Próximo &raquo;</button>`;
                }
                paginacaoContainer.innerHTML = paginationHTML;
            }
        }

        

                function abrirModalAtalho() {
            $('#atalho-nome').value = '';
            $('#atalho-link').value = '';
            $('#modal-atalho').classList.add('active');
        }

        async function salvarAtalho(e) {
            e.preventDefault();
            const nome = $('#atalho-nome').value;
            const link = $('#atalho-link').value;

            if (!nome || !link) {
                showNotif('danger', 'Por favor, preencha todos os campos.');
                return;
            }

            showSpinner('Salvando...');
            try {
                await db.collection('atalhos').add({ nome, link });
                showNotif('success', 'Atalho salvo com sucesso!');
                fecharModal('modal-atalho');
                renderAtalhos();
            } catch (err) {
                console.error(err);
                showNotif('danger', 'Erro ao salvar o atalho.');
            } finally {
                hideSpinner();
            }
        }

        async function renderAtalhos() {
            const atalhosContainer = $('#atalhos-container');
            atalhosContainer.innerHTML = '';
            const snapshot = await db.collection('atalhos').get();
            if (!snapshot.empty) {
                let html = '<h3>Atalhos Rápidos:</h3>';
                snapshot.forEach(doc => {
                    const atalho = doc.data();
                    html += `<a href="${atalho.link}" target="_blank" class="btn">${atalho.nome}</a>`;
                });
                atalhosContainer.innerHTML = html;
            }
        }

        function abrirModalGerenciarAtalhos() {
            listarAtalhosEdicao();
            $('#modal-gerenciar-atalhos').classList.add('active');
        }

        async function listarAtalhosEdicao() {
            const container = $('#atalhos-edicao-container');
            container.innerHTML = SPINNER_HTML;
            try {
                const snapshot = await db.collection('atalhos').get();
                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align:center; padding:1rem;">Nenhum atalho criado.</p>';
                    return;
                }
                let html = '<table><thead><tr><th>Nome</th><th>Link</th><th>Ações</th></tr></thead><tbody>';
                snapshot.forEach(doc => {
                    const a = doc.data();
                    html += `<tr>
                        <td data-label="Nome"><input id="edit-nome-${doc.id}" type="text" value="${a.nome}" style="width:100%"></td>
                        <td data-label="Link"><input id="edit-link-${doc.id}" type="url" value="${a.link}" style="width:100%"></td>
                        <td data-label="Ações"><div class="actions">
                            <button onclick="salvarEdicaoAtalho('${doc.id}')" title="Salvar"><i class="fa fa-save"></i></button>
                            <button onclick="deletarAtalho('${doc.id}')" title="Excluir"><i class="fa fa-trash"></i></button>
                        </div></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p style="text-align:center; padding:1rem;">Erro ao carregar atalhos.</p>';
            }
        }

        async function salvarEdicaoAtalho(id) {
            const nome = document.getElementById('edit-nome-' + id).value;
            const link = document.getElementById('edit-link-' + id).value;
            if (!nome || !link) {
                return showNotif('danger', 'Por favor, preencha todos os campos.');
            }
            showSpinner('Salvando...');
            try {
                await db.collection('atalhos').doc(id).update({ nome, link });
                showNotif('success', 'Atalho atualizado!');
                listarAtalhosEdicao();
                renderAtalhos();
            } catch (err) {
                console.error(err);
                showNotif('danger', 'Erro ao salvar o atalho.');
            } finally {
                hideSpinner();
            }
        }

        function deletarAtalho(id) {
            delRow('atalhos', id, () => { listarAtalhosEdicao(); renderAtalhos(); });
        }

        async function renderDocumentos(page = 1) {
            await renderAtalhos(); // Renderiza os atalhos antes de renderizar os documentos
            $('#tabela-documentos').innerHTML = SPINNER_HTML;
            const buscaCliente = $('#doc-filtro-cliente-busca').value.toLowerCase();

            // Otimização: Carregar mapas de clientes e casos uma vez
            const [clientesSnapshot, casosSnapshot, docsSnapshot] = await Promise.all([
                db.collection('clientes').get(),
                db.collection('casos').get(),
                db.collection('docs').get() // Pega todos os documentos
            ]);

            const clientesMap = new Map(clientesSnapshot.docs.map(doc => [doc.id, doc.data().nome]));
            const casosMap = new Map(casosSnapshot.docs.map(doc => [doc.id, doc.data().numero]));

            let rows = docsSnapshot.docs.map(doc => {
                const r = { id: doc.id, ...doc.data() };
                r.clienteNome = clientesMap.get(r.cliente_id) || 'N/A';
                r.casoNumero = casosMap.get(r.caso_id) || 'N/A';
                return r;
            });

            // Filtra no lado do cliente
            if (buscaCliente) {
                rows = rows.filter(r => r.clienteNome.toLowerCase().includes(buscaCliente));
            }

            // Ordena os resultados pela data (mais recente primeiro)
            rows.sort((a, b) => new Date(b.data) - new Date(a.data));

            const table = $('#tabela-documentos');
            const paginacaoContainer = $('#paginacao-documentos');
            paginacaoContainer.innerHTML = '';

            if (rows.length === 0) {
                table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum documento encontrado.</p>`;
                return;
            }

            const totalRows = rows.length;
            const rowsPerPage = 20;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedRows = rows.slice(start, end);

            table.innerHTML = `<table><thead><tr><th>Título</th><th>Cliente</th><th>Caso</th><th>Data</th><th>Arquivo</th><th>Ações</th></tr></thead><tbody>

            ${paginatedRows.map(r => `<tr>
                <td data-label="Título">${r.titulo}</td>
                <td data-label="Cliente">${r.clienteNome}</td>
                <td data-label="Caso">${r.casoNumero}</td>
                <td data-label="Data">${fmtDate(r.data)}</td>
                <td data-label="Arquivo"><a href="${r.link}" target="_blank" class="btn btn-info"><i class="fa fa-download"></i> Abrir</a></td>
                <td data-label="Ações"><div class="actions">
                    <button onclick="abrirModalDocumento('${r.id}')" title="Editar"><i class="fa fa-edit"></i></button>
                    <button onclick="delRow('docs', '${r.id}', () => renderDocumentos(${page}))" title="Excluir"><i class="fa fa-trash"></i></button>
                </div></td>
            </tr>`).join('')}</tbody></table>`;

            if (totalPages > 1) {
                let paginationHTML = '';
                if (page > 1) {
                    paginationHTML += `<button onclick="renderDocumentos(${page - 1})">&laquo; Anterior</button>`;
                }
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button onclick="renderDocumentos(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
                }
                if (page < totalPages) {
                    paginationHTML += `<button onclick="renderDocumentos(${page + 1})">Próximo &raquo;</button>`;
                }
                paginacaoContainer.innerHTML = paginationHTML;
            }
        }

        async function renderAgenda(page = 1) {
            $('#tabela-agenda').innerHTML = SPINNER_HTML;
            const dataFiltro = $('#agenda-filtro-data').value;
            const tipoFiltro = $('#agenda-filtro-tipo').value;

            let query = db.collection('agenda');
            if (tipoFiltro) query = query.where('tipo_evento', '==', tipoFiltro);

            const snapshot = await query.orderBy('datahora', 'desc').get();
            const table = $('#tabela-agenda');
            const paginacaoContainer = $('#paginacao-agenda');
            paginacaoContainer.innerHTML = '';

            if (snapshot.empty) {
                table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum evento encontrado.</p>`;
                return;
            }

            let rows = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(r => !dataFiltro || r.datahora.startsWith(dataFiltro));

            const totalRows = rows.length;
            const rowsPerPage = 20;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedRows = rows.slice(start, end);

            table.innerHTML = `<table><thead><tr><th>Título</th><th>Tipo</th><th>Data/Hora</th><th>Local</th><th>Status</th><th>Ações</th></tr></thead><tbody>
            ${paginatedRows.map(r => `<tr>
                <td data-label="Título">${r.titulo}</td>
                <td data-label="Tipo">${r.tipo_evento}</td>
                <td data-label="Data/Hora">${fmtDateTime(r.datahora)}</td>
                <td data-label="Local">${r.local || ''}</td>
                <td data-label="Status"><span class="badge ${r.status}">${r.status}</span></td>
                <td data-label="Ações"><div class="actions">
                    <button onclick="abrirModalEvento('${r.id}')" title="Editar"><i class="fa fa-edit"></i></button>
                    <button onclick="delRow('agenda', '${r.id}', () => renderAgenda(${page}))" title="Excluir"><i class="fa fa-trash"></i></button>
                </div></td>
            </tr>`).join('')}</tbody></table>`;

            if (totalPages > 1) {
                let paginationHTML = '';
                if (page > 1) {
                    paginationHTML += `<button onclick="renderAgenda(${page - 1})">&laquo; Anterior</button>`;
                }
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button onclick="renderAgenda(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
                }
                if (page < totalPages) {
                    paginationHTML += `<button onclick="renderAgenda(${page + 1})">Próximo &raquo;</button>`;
                }
                paginacaoContainer.innerHTML = paginationHTML;
            }
        }

        async function renderTarefas(page = 1) {
            $('#tabela-tarefas').innerHTML = SPINNER_HTML;
            const status = $('#filtro-tarefa-status').value;
            const prioridade = $('#filtro-tarefa-prioridade').value;

            let query = db.collection('tarefas');
            if (status) query = query.where('status', '==', status);
            if (prioridade) query = query.where('prioridade', '==', prioridade);

            const snapshot = await query.orderBy('prazo_data').get();
            const table = $('#tabela-tarefas');
            const paginacaoContainer = $('#paginacao-tarefas');
            paginacaoContainer.innerHTML = '';

            if (snapshot.empty) {
                table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhuma tarefa encontrada.</p>`;
                return;
            }

            let rows = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const totalRows = rows.length;
            const rowsPerPage = 20;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedRows = rows.slice(start, end);

            table.innerHTML = `<table><thead><tr><th>Descrição</th><th>Status</th><th>Prioridade</th><th>Prazo</th><th>Ações</th></tr></thead><tbody>
            ${paginatedRows.map(r => `<tr>
                <td data-label="Descrição">${r.descricao}</td>
                <td data-label="Status"><span class="badge ${r.status}">${r.status}</span></td>
                <td data-label="Prioridade"><span class="badge ${r.prioridade}">${r.prioridade}</span></td>
                <td data-label="Prazo">${fmtDate(r.prazo_data)}</td>
                <td data-label="Ações"><div class="actions">
                    <button onclick="abrirModalTarefa('${r.id}')" title="Editar"><i class="fa fa-edit"></i></button>
                    <button onclick="delRow('tarefas', '${r.id}', () => renderTarefas(${page}))" title="Excluir"><i class="fa fa-trash"></i></button>
                </div></td>
            </tr>`).join('')}</tbody></table>`;

            if (totalPages > 1) {
                let paginationHTML = '';
                if (page > 1) {
                    paginationHTML += `<button onclick="renderTarefas(${page - 1})">&laquo; Anterior</button>`;
                }
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button onclick="renderTarefas(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
                }
                if (page < totalPages) {
                    paginationHTML += `<button onclick="renderTarefas(${page + 1})">Próximo &raquo;</button>`;
                }
                paginacaoContainer.innerHTML = paginationHTML;
            }
        }

        async function renderFinanceiro() {
            $('#tabela-financeiro').innerHTML = SPINNER_HTML;
            $('#resumo-financeiro').innerHTML = SPINNER_HTML;

            const snapshot = await db.collection('fin').orderBy('data', 'desc').get();
            const table = $('#tabela-financeiro');
            const resumo = $('#resumo-financeiro');

            if (snapshot.empty) {
                table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum lançamento encontrado.</p>`;
                resumo.innerHTML = '';
                return;
            }

            let totalRecebido = 0, totalAReceber = 0, totalDespesas = 0, saldo = 0;
            snapshot.forEach(doc => {
                const r = doc.data();
                if (r.tipo === 'Receber') {
                    if (r.status_pg === 'Pago') {
                        totalRecebido += Number(r.valor);
                    } else if (r.status_pg === 'Pendente') {
                        totalAReceber += Number(r.valor);
                    }
                } else { // Assumindo que tipo 'Pagar'
                    totalDespesas += Number(r.valor);
                }
            });
            saldo = totalRecebido - totalDespesas;

            resumo.innerHTML = `
                <div class="card"><i class="icon fa fa-hand-holding-dollar" style="color:var(--success)"></i><div class="value">${fmtCurrency(totalRecebido)}</div><div class="label">Total Recebido</div></div>
                <div class="card"><i class="icon fa fa-hourglass-half" style="color:var(--warning)"></i><div class="value">${fmtCurrency(totalAReceber)}</div><div class="label">Total a Receber</div></div>
                <div class="card"><i class="icon fa fa-arrow-down" style="color:var(--danger)"></i><div class="value">${fmtCurrency(totalDespesas)}</div><div class="label">Total de Despesas</div></div>
                <div class="card"><i class="icon fa fa-balance-scale" style="color:var(--info)"></i><div class="value">${fmtCurrency(saldo)}</div><div class="label">Saldo (Recebido - Desp.)</div></div>
            `;

            table.innerHTML = `<table><thead><tr><th>Descrição</th><th>Tipo</th><th>Categoria</th><th>Valor</th><th>Data</th><th>Status</th><th>Ações</th></tr></thead><tbody>
            ${snapshot.docs.map(doc => {
                const r = { id: doc.id, ...doc.data() };
                return `<tr>
                    <td data-label="Descrição">${r.descricao}</td>
                    <td data-label="Tipo"><span class="badge ${r.tipo}">${r.tipo}</span></td>
                    <td data-label="Categoria">${r.categoria}</td>
                    <td data-label="Valor">${fmtCurrency(r.valor)}</td>
                    <td data-label="Data">${fmtDate(r.data)}</td>
                    <td data-label="Status"><span class="badge ${r.status_pg}">${r.status_pg}</span></td>
                    <td data-label="Ações"><div class="actions">
                        <button onclick="abrirModalFin(null, '${r.id}')" title="Editar"><i class="fa fa-edit"></i></button>
                        <button onclick="delRow('fin', '${r.id}', renderFinanceiro)" title="Excluir"><i class="fa fa-trash"></i></button>
                    </div></td>
                </tr>`
            }).join('')}</tbody></table>`;
        }

        async function renderCasosPorCliente(page = 1) {
            const container = $('#casos-por-cliente-container');
            container.innerHTML = SPINNER_HTML;
            const busca = $('#buscar-casos-por-cliente').value.toLowerCase();

            const [clientesSnapshot, casosSnapshot] = await Promise.all([
                db.collection('clientes').orderBy('nome').get(),
                db.collection('casos').get()
            ]);

            const casosPorCliente = new Map();
            casosSnapshot.forEach(doc => {
                const caso = { id: doc.id, ...doc.data() };
                if (!casosPorCliente.has(caso.cliente_id)) {
                    casosPorCliente.set(caso.cliente_id, []);
                }
                casosPorCliente.get(caso.cliente_id).push(caso);
            });

            let clientesFiltrados = clientesSnapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(c => !busca || c.nome.toLowerCase().includes(busca));

            const paginacaoContainer = $('#paginacao-casos-por-cliente');
            paginacaoContainer.innerHTML = '';
            const totalRows = clientesFiltrados.length;
            const rowsPerPage = 10; // Menos clientes por página para melhor visualização
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedClientes = clientesFiltrados.slice(start, end);

            if (paginatedClientes.length === 0) {
                container.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum cliente encontrado.</p>`;
                return;
            }

            let html = '';
            paginatedClientes.forEach(cliente => {
                html += `<div class="cliente-card"><h3>${cliente.nome}</h3>`;
                const casos = casosPorCliente.get(cliente.id) || [];
                if (casos.length > 0) {
                    html += '<table><thead><tr><th>Nº Processo</th><th>Partes</th><th>Status</th></tr></thead><tbody>';
                    casos.forEach(caso => {
                        html += `<tr>
                            <td data-label="Nº Processo">${caso.numero}</td>
                            <td data-label="Partes">${caso.partes || ''}</td>
                            <td data-label="Status"><span class="badge ${caso.status}">${caso.status}</span></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<p>Nenhum caso vinculado a este cliente.</p>';
                }
                html += '</div>';
            });
            container.innerHTML = html;

            if (totalPages > 1) {
                let paginationHTML = '';
                if (page > 1) {
                    paginationHTML += `<button onclick="renderCasosPorCliente(${page - 1})">&laquo; Anterior</button>`;
                }
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button onclick="renderCasosPorCliente(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
                }
                if (page < totalPages) {
                    paginationHTML += `<button onclick="renderCasosPorCliente(${page + 1})">Próximo &raquo;</button>`;
                }
                paginacaoContainer.innerHTML = paginationHTML;
            }
        }

        /* ------------- FUNÇÕES DE ABERTURA DE MODAIS ------------- */

        async function abrirModalCaso(id = null) {
            showSpinner('Carregando...');
            $('#modal-caso form').reset();
            $('#caso-id').value = '';
            await populateSelect('caso-cliente', 'clientes', 'id', 'nome', null, 'Selecione o cliente');
            if (id) {
                $('#modal-caso-titulo').innerText = 'Editar Caso';
                const doc = await db.collection('casos').doc(id).get();
                if (doc.exists) {
                    const r = doc.data();
                    $('#caso-id').value = id;
                    $('#caso-cliente').value = r.cliente_id;
                    $('#caso-numero').value = r.numero;
                    $('#caso-partes').value = r.partes;
                    $('#caso-responsavel').value = r.responsavel;
                    $('#caso-data').value = r.data;
                    $('#caso-status').value = r.status;
                }
            }
            else {
                $('#modal-caso-titulo').innerText = 'Novo Caso';
            }
            hideSpinner();
            $('#modal-caso').classList.add('active');
        }

        async function abrirModalCliente(id = null) {
            $('#modal-cliente form').reset();
            $('#cliente-id').value = '';
            if (id) {
                $('#modal-cliente-titulo').innerText = 'Editar Cliente';
                const doc = await db.collection('clientes').doc(id).get();
                if (doc.exists) {
                    const r = doc.data();
                    $('#cliente-id').value = id;
                    $('#cliente-nome').value = r.nome;
                    $('#cliente-email').value = r.email;
                    $('#cliente-fone').value = r.fone;
                    $('#cliente-notas').value = r.notas;
                }
            } else {
                $('#modal-cliente-titulo').innerText = 'Novo Cliente';
            }
            $('#modal-cliente').classList.add('active');
        }

        async function abrirModalDocumento(id = null) {
            showSpinner('Carregando...');
            $('#modal-documento form').reset();
            $('#doc-id').value = '';
            await populateSelect('doc-cliente', 'clientes', 'id', 'nome', null, 'Selecione o cliente');
            $('#doc-caso').innerHTML = '<option value="">Nenhum</option>'; // Reset
            $('#doc-cliente').onchange = () => populateSelect('doc-caso', 'casos', 'id', 'numero', $('#doc-cliente').value, 'Nenhum');

            if (id) {
                const doc = await db.collection('docs').doc(id).get();
                if (doc.exists) {
                    const r = doc.data();
                    $('#doc-id').value = id;
                    $('#doc-titulo').value = r.titulo;
                    $('#doc-link').value = r.link;
                    $('#doc-cliente').value = r.cliente_id;
                    await populateSelect('doc-caso', 'casos', 'id', 'numero', r.cliente_id, 'Nenhum', r.caso_id);
                }
            }
            hideSpinner();
            $('#modal-documento').classList.add('active');
        }

        async function abrirModalEvento(id = null, defaultDate = null) {
            showSpinner('Carregando...');
            $('#modal-evento form').reset();
            $('#evento-id').value = '';
            await populateSelect('evento-cliente', 'clientes', 'id', 'nome', null, 'Nenhum');
            $('#evento-caso').innerHTML = '<option value="">Nenhum</option>';

            if (id) {
                $('#evento-modal-titulo').innerText = 'Editar Evento';
                const doc = await db.collection('agenda').doc(id).get();
                if (doc.exists) {
                    const r = doc.data();
                    $('#evento-id').value = id;
                    $('#evento-titulo').value = r.titulo;
                    $('#evento-tipo').value = r.tipo_evento;
                    $('#evento-datahora').value = r.datahora;
                    $('#evento-local').value = r.local;
                    $('#evento-status').value = r.status;
                    $('#evento-descricao').value = r.descricao;
                    if (r.cliente_id) {
                        $('#evento-cliente').value = r.cliente_id;
                        await populateSelect('evento-caso', 'casos', 'id', 'numero', r.cliente_id, 'Nenhum', r.caso_id);
                    }
                }
            } else {
                $('#evento-modal-titulo').innerText = 'Novo Evento / Prazo';
                if (defaultDate) {
                    // Formata a data para o input datetime-local (YYYY-MM-DDTHH:mm)
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    $('#evento-datahora').value = `${defaultDate.split('T')[0]}T${hours}:${minutes}`;
                }
            }
            hideSpinner();
            $('#modal-evento').classList.add('active');
        }

        async function abrirModalTarefa(id = null) {
            showSpinner('Carregando...');
            $('#modal-tarefa form').reset();
            $('#tarefa-id').value = '';
            await populateSelect('tarefa-cliente', 'clientes', 'id', 'nome', null, 'Nenhum');
            $('#tarefa-caso').innerHTML = '<option value="">Nenhum</option>';

            if (id) {
                $('#tarefa-modal-titulo').innerText = 'Editar Tarefa';
                const doc = await db.collection('tarefas').doc(id).get();
                if (doc.exists) {
                    const r = doc.data();
                    $('#tarefa-id').value = id;
                    $('#tarefa-descricao').value = r.descricao;
                    $('#tarefa-prioridade').value = r.prioridade;
                    $('#tarefa-prazo').value = r.prazo_data;
                    if (r.cliente_id) {
                        $('#tarefa-cliente').value = r.cliente_id;
                        await populateSelect('tarefa-caso', 'casos', 'id', 'numero', r.cliente_id, 'Nenhum', r.caso_id);
                    }
                }
            } else {
                $('#tarefa-modal-titulo').innerText = 'Nova Tarefa';
            }
            hideSpinner();
            $('#modal-tarefa').classList.add('active');
        }

        async function abrirModalFin(tipo, id = null) {
            showSpinner('Carregando...');
            $('#modal-fin form').reset();
            $('#fin-id').value = '';
            await populateSelect('fin-cliente', 'clientes', 'id', 'nome', null, 'Nenhum');
            $('#fin-caso').innerHTML = '<option value="">Nenhum</option>';

            if (id) {
                const doc = await db.collection('fin').doc(id).get();
                if (doc.exists) {
                    const r = doc.data();
                    $('#fin-titulo').innerText = `Editar Lançamento`;
                    $('#fin-id').value = id;
                    $('#fin-tipo').value = r.tipo;
                    $('#fin-descricao').value = r.descricao;
                    $('#fin-categoria').value = r.categoria;
                    $('#fin-valor').value = r.valor;
                    $('#fin-data').value = r.data;
                    $('#fin-status').value = r.status_pg;
                    if (r.cliente_id) {
                        $('#fin-cliente').value = r.cliente_id;
                        await populateSelect('fin-caso', 'casos', 'id', 'numero', r.cliente_id, 'Nenhum', r.caso_id);
                    }
                }
            } else {
                $('#fin-titulo').innerText = `Nova ${tipo === 'Receber' ? 'Receita' : 'Despesa'}`;
                $('#fin-tipo').value = tipo;
            }
            hideSpinner();
            $('#modal-fin').classList.add('active');
        }

        /* ------------- FUNÇÕES DE SALVAR/DELETAR ------------- */

        async function salvarCaso(e) {
            e.preventDefault();
            showSpinner('Salvando...');
            const id = $('#caso-id').value;
            const dados = {
                cliente_id: $('#caso-cliente').value,
                numero: $('#caso-numero').value,
                partes: $('#caso-partes').value,
                responsavel: $('#caso-responsavel').value,
                data: $('#caso-data').value,
                status: $('#caso-status').value,
            };
            try {
                if (id) {
                    await db.collection('casos').doc(id).update(dados);
                } else {
                    await db.collection('casos').add(dados);
                }
                showNotif('success', 'Caso salvo com sucesso!');
                fecharModal('modal-caso');
                renderCasos();
            } catch (err) {
                console.error(err);
                showNotif('danger', 'Erro ao salvar o caso.');
            } finally {
                hideSpinner();
            }
        }

        async function salvarCliente(e) {
            e.preventDefault();
            showSpinner('Salvando...');
            const id = $('#cliente-id').value;
            const dados = {
                nome: $('#cliente-nome').value,
                email: $('#cliente-email').value,
                fone: $('#cliente-fone').value,
                notas: $('#cliente-notas').value,
            };
            try {
                if (id) {
                    await db.collection('clientes').doc(id).update(dados);
                } else {
                    await db.collection('clientes').add(dados);
                }
                showNotif('success', 'Cliente salvo com sucesso!');
                fecharModal('modal-cliente');
                renderClientes();
            } catch (err) {
                console.error(err);
                showNotif('danger', 'Erro ao salvar o cliente.');
            } finally {
                hideSpinner();
            }
        }

        async function salvarDocumento(e) {
            e.preventDefault();
            showSpinner('Salvando...');
            const id = $('#doc-id').value;
            const dados = {
                cliente_id: $('#doc-cliente').value,
                caso_id: $('#doc-caso').value,
                titulo: $('#doc-titulo').value,
                link: $('#doc-link').value,
                data: new Date().toISOString().split('T')[0] // Data atual
            };
            try {
                if (id) {
                    await db.collection('docs').doc(id).update(dados);
                } else {
                    await db.collection('docs').add(dados);
                }
                showNotif('success', 'Documento salvo com sucesso!');
                fecharModal('modal-documento');
                renderDocumentos();
            } catch (err) {
                console.error(err);
                showNotif('danger', 'Erro ao salvar o documento.');
            } finally {
                hideSpinner();
            }
        }

        async function salvarEvento(e) {
            e.preventDefault();
            showSpinner('Salvando...');
            const id = $('#evento-id').value;
            const dados = {
                titulo: $('#evento-titulo').value,
                tipo_evento: $('#evento-tipo').value,
                datahora: $('#evento-datahora').value,
                local: $('#evento-local').value,
                cliente_id: $('#evento-cliente').value,
                caso_id: $('#evento-caso').value,
                status: $('#evento-status').value,
                descricao: $('#evento-descricao').value,
            };
            try {
                if (id) {
                    await db.collection('agenda').doc(id).update(dados);
                } else {
                    await db.collection('agenda').add(dados);
                }
                showNotif('success', 'Evento salvo com sucesso!');
                fecharModal('modal-evento');
                if (calendar) calendar.refetchEvents(); // Atualiza o calendário
                renderAgenda(); // Atualiza a lista de agenda se estiver visível
            } catch (err) {
                console.error(err);
                showNotif('danger', 'Erro ao salvar o evento.');
            } finally {
                hideSpinner();
            }
        }

        async function salvarTarefa(e) {
            e.preventDefault();
            showSpinner('Salvando...');
            const id = $('#tarefa-id').value;
            const dados = {
                descricao: $('#tarefa-descricao').value,
                prioridade: $('#tarefa-prioridade').value,
                prazo_data: $('#tarefa-prazo').value,
                cliente_id: $('#tarefa-cliente').value,
                caso_id: $('#tarefa-caso').value,
                status: 'Pendente' // Default status
            };
            try {
                if (id) {
                    // Ao editar, não alteramos o status, a menos que haja um campo para isso
                    const doc = await db.collection('tarefas').doc(id).get();
                    dados.status = doc.exists ? doc.data().status : 'Pendente';
                    await db.collection('tarefas').doc(id).update(dados);
                } else {
                    await db.collection('tarefas').add(dados);
                }
                showNotif('success', 'Tarefa salva com sucesso!');
                fecharModal('modal-tarefa');
                renderTarefas();
                loadDashboard(); // Atualiza o calendário
            } catch (err) {
                console.error(err);
                showNotif('danger', 'Erro ao salvar a tarefa.');
            } finally {
                hideSpinner();
            }
        }

        async function salvarFin(e) {
            e.preventDefault();
            showSpinner('Salvando...');
            const id = $('#fin-id').value;
            const dados = {
                tipo: $('#fin-tipo').value,
                descricao: $('#fin-descricao').value,
                categoria: $('#fin-categoria').value,
                valor: parseFloat($('#fin-valor').value),
                data: $('#fin-data').value,
                status_pg: $('#fin-status').value,
                cliente_id: $('#fin-cliente').value,
                caso_id: $('#fin-caso').value,
            };
            try {
                if (id) {
                    await db.collection('fin').doc(id).update(dados);
                } else {
                    await db.collection('fin').add(dados);
                }
                showNotif('success', 'Lançamento salvo com sucesso!');
                fecharModal('modal-fin');
                renderFinanceiro();
                loadDashboard(); // Atualiza o resumo
            } catch (err) {
                console.error(err);
                showNotif('danger', 'Erro ao salvar o lançamento.');
            } finally {
                hideSpinner();
            }
        }

        async function delRow(collection, id, callback) {
            if (confirm('Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.')) {
                showSpinner('Excluindo...');
                try {
                    await db.collection(collection).doc(id).delete();
                    showNotif('success', 'Item excluído com sucesso.');
                    if (callback) callback();
                } catch (err) {
                    console.error(err);
                    showNotif('danger', 'Erro ao excluir o item.');
                } finally {
                    hideSpinner();
                }
            }
        }

        /* ------------- NAVEGAÇÃO E INICIALIZAÇÃO ------------- */

        function abrirTab(index) {
            $$('.tab-content').forEach(t => t.classList.remove('active'));
            $$('nav button').forEach(b => b.classList.remove('active'));
            $$('.sidebar-nav button').forEach(b => b.classList.remove('active'));

            $(`#tab${index}`).classList.add('active');
            $(`#nav${index}`)?.classList.add('active');
            $(`#nav${index}-sidebar`)?.classList.add('active');

            // Carrega os dados da aba quando ela é aberta
            switch (index) {
                case 0: loadDashboard(); break;
                case 1: renderCasos(); break;
                case 2: renderClientes(); break;
                case 3: renderDocumentos(); break;
                case 4: renderAgenda(); break;
                case 5: renderTarefas(); break;
                case 6: renderFinanceiro(); break;
                case 7: renderCasosPorCliente(); break;
            }
        }

        // Função para gerar relatórios CSV
        async function gerarRelatorio(collectionName, fileName, headers) {
            showSpinner('Gerando relatório...');
            try {
                const snapshot = await db.collection(collectionName).get();
                if (snapshot.empty) {
                    showNotif('info', 'Não há dados para gerar este relatório.');
                    return;
                }

                // Mapeamento de clientes e casos para evitar múltiplas buscas
                let clientesMap, casosMap;
                if (collectionName !== 'clientes') {
                    const clientesSnapshot = await db.collection('clientes').get();
                    clientesMap = new Map(clientesSnapshot.docs.map(doc => [doc.id, doc.data().nome]));
                }
                if (['docs', 'agenda', 'tarefas', 'fin'].includes(collectionName)) {
                    const casosSnapshot = await db.collection('casos').get();
                    casosMap = new Map(casosSnapshot.docs.map(doc => [doc.id, doc.data().numero]));
                }

                let csvContent = "data:text/csv;charset=utf-8," + Object.values(headers).join(",") + "\n";
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };

                    // Adiciona nomes de cliente/caso se necessário
                    if (clientesMap && data.cliente_id) {
                        data.cliente_nome = clientesMap.get(data.cliente_id) || 'N/A';
                    }
                    if (casosMap && data.caso_id) {
                        data.caso_numero = casosMap.get(data.caso_id) || 'N/A';
                    }

                    const row = Object.keys(headers).map(key => {
                        let value = data[key] || '';
                        // Formata valores para CSV (aspas duplas para strings com vírgula)
                        value = String(value).replace(/"/g, '""');
                        if (String(value).includes(',')) {
                            value = `"${value}"`;
                        }
                        return value;
                    });
                    csvContent += row.join(",") + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotif('success', 'Relatório gerado com sucesso!');

            } catch (err) {
                console.error("Erro ao gerar relatório: ", err);
                showNotif('danger', 'Falha ao gerar o relatório.');
            } finally {
                hideSpinner();
            }
        }

        // --- Funções de Autenticação ---

        // Função de Login com Firebase Auth
        async function fazerLogin() {
            const email = $('#login-email').value;
            const senha = $('#login-senha').value;
            const erroDiv = $('#login-erro');
            erroDiv.style.display = 'none';

            if (!email || !senha) {
                erroDiv.innerText = 'Por favor, preencha e-mail e senha.';
                erroDiv.style.display = 'block';
                return;
            }

            showSpinner('Verificando...');

            try {
                await firebase.auth().signInWithEmailAndPassword(email, senha);
                // O onAuthStateChanged vai cuidar de mostrar o app.
                // Apenas notificamos o sucesso aqui.
                showNotif('success', 'Login bem-sucedido!');
            } catch (error) {
                console.error("Erro no login: ", error.code);
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        erroDiv.innerText = 'E-mail ou senha incorretos.';
                        break;
                    case 'auth/invalid-email':
                        erroDiv.innerText = 'O formato do e-mail é inválido.';
                        break;
                    default:
                        erroDiv.innerText = 'Erro ao tentar fazer login. Tente novamente.';
                }
                erroDiv.style.display = 'block';
            } finally {
                hideSpinner();
            }
        }

        // Função de Logout com Firebase Auth
        function fazerLogout() {
            if (confirm('Deseja realmente sair?')) {
                showSpinner('Saindo...');
                firebase.auth().signOut().catch(error => {
                    console.error('Erro ao fazer logout:', error);
                    showNotif('danger', 'Ocorreu um erro ao sair.');
                }).finally(() => {
                    hideSpinner();
                });
            }
        }

        // --- Event Listeners e Inicialização ---

        $('#btnLogin').addEventListener('click', fazerLogin);
        $('#btnLogout').addEventListener('click', fazerLogout);

        // Hamburger Menu Logic
        const hamburger = document.getElementById('hamburger-menu');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        hamburger.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });

        function closeSidebar() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Gerenciador de estado de autenticação
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    // Usuário está logado
                    $('#login-panel').style.display = 'none';
                    $('#app').style.display = 'block';
                    abrirTab(0); // Carrega a primeira tab do dashboard
                } else {
                    // Usuário não está logado
                    $('#login-panel').style.display = 'block';
                    $('#app').style.display = 'none';
                    $('#login-email').value = '';
                    $('#login-senha').value = '';
                }
                // Esconde o spinner global caso esteja visível na transição
                hideSpinner();
            });
        });

    </script>
</body>

</html>